<%= simple_form_for @search, as: "search", url: results_find_index_path, method: :get, remote: true do |f| %>
  <div class="row">
    <%= f.input :category_name, input_html: {class: "typeahead", autocomplete: 'off' }, wrapper_html: {class:"col-md-8"}, label: false, placeholder: "What part are you looking for?" %>
    <%= f.input :category_id, as: :hidden %>
    <%= f.input :fitment_note_id, collection: [], wrapper_html: { class:"col-md-4" }, label: false, disabled: true %>
  </div>
  <%= f.input :vehicle_brand, collection: @brands, class:"form-control", label: false, prompt: "Make...", input_html: {class: "chosen-select" } %>
  <%= f.input :vehicle_model, collection: [], class: "form-control", label: false, prompt: "Model...", input_html: {class: "chosen-select" }%>
  <%= f.input :vehicle_submodel, collection: [], class:"form-control", label: false, prompt: "Submodel..." %>
  <%= f.input :vehicle_year, collection: [], prompt: "Year...", label: false, class:"form-control" %>
  <%= hidden_field_tag "search[vehicle][id]", nil, id: "search_vehicle" %>
  <%= f.submit "Find", id: "find-compatibilities-process", class: "btn btn-default" %>
<% end %>

<script type="text/javascript">
  var categories = new Bloodhound({
    datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    prefetch: {url: '/categories/1/leaves.json',
               ttl: 3600000 } // Locally cache results for 1 hr
  });

  $('.typeahead').typeahead({
    hint: true,
    highlight: true,
    autoselect: true
  },
  {
    name: 'categories',
    display: 'name',
    limit: 10,
    source: categories
  });
  $('.typeahead').bind('typeahead:select', function(ev, suggestion) {
    $('#search_category_id').val(suggestion.id);
    $('#search_category_id').trigger('change');
  });

  $('#search_category_id').on("change", function() {
    var select = $('#search_fitment_note_id')
    select.empty();
    var categoryId = $(this).val();
    if (categoryId > 0 ) {
      var url = "/categories/"+categoryId+"/fitment_notes";
      $.getJSON(url, function(json){
        if ( json.length > 0 ) {
          select.empty();
          select.append($('<option>').text("Specify..."));
          $.each(json, function(i, obj){
            select.append($('<option>').text(obj.name).attr('value', obj.id));
          });
          select.prop('disabled', false);
        } else {
          select.prop('disabled', true);
        };
      });
    };
  });

  dynamic_vehicle_form("search_vehicle");
  $("#search_vehicle_year").on("change", function() {
    var vehicleId = $(this).val();
    $("#search_vehicle").val(vehicleId);
  });
</script>
