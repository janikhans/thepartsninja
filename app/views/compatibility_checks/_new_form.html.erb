<%= simple_form_for @compatibility_check, url: results_check_path, method: :get, html: { class: "check-form" }, remote: true do |f| %>
  <div class="card m-b-md" style="overflow: visible">
    <div class="search-container">
      <div class="search-display">
        <div class="row search-box">
          <%= f.input :category_name, input_html: {class: "typeahead", autocomplete: "off"}, wrapper_html: {class:"col-md-8"}, label: false, placeholder: "What part are you looking for?" %>
          <%= f.input :category_id, as: :hidden %>
          <%= f.input :fitment_note_id, collection: [], wrapper_html: { class:"col-md-4" }, label: false, disabled: true %>
        </div>
      </div>
    </div>
  </div>
  <div class="card" style="overflow: visible">
    <div class="search-tags">
      <div class="col-md-6 query-placeholder">
        <div id="vehicle_one" class="query-tag">
          <span id="vehicle_one_year"></span>
          <span id="vehicle_one_brand"></span>
          <span id="vehicle_one_model"></span>
          <span id="vehicle_one_submodel"></span>
          <%= link_to icon(:times), "#", class: "muted" %>
        </div>
      </div>
      <div class="col-md-6 query-placeholder">
        <div id="vehicle_two" class="query-tag">
          <span id="vehicle_two_year"></span>
          <span id="vehicle_two_brand"></span>
          <span id="vehicle_two_model"></span>
          <span id="vehicle_two_submodel"></span>
          <%= link_to icon(:times), "#", class: "muted" %>
        </div>
      </div>
    </div>
    <div class="row search-inputs">
      <div class="col-md-6 input">
        <%= link_to "#", onclick: "show_popover_select($(this))" do %>
          <%= icon(:motorcycle) %> Vehicle One<b class="caret"></b>
        <% end %>
        <div class="popover-select hide">
          <%= f.input :vehicle_one_brand, collection: @brands, class:"form-control", label: false, prompt: "Make...", input_html: {class: "chosen-select" } %>
          <%= f.input :vehicle_one_model, collection: [], class: "form-control", label: false, prompt: "Model...", input_html: {class: "chosen-select" }%>
          <%= f.input :vehicle_one_submodel, collection: [], class:"form-control", label: false, prompt: "Submodel..." %>
          <%= f.input :vehicle_one_year, collection: [], prompt: "Year...", label: false, class:"form-control" %>
          <%= hidden_field_tag "compatibility_check[vehicles][][id]", nil, id: "compatibility_check_vehicle_one_id" %>
        </div>
      </div>
      <div class="col-md-6 input">
        <%= link_to "#", onclick: "show_popover_select($(this))" do %>
          <%= icon(:motorcycle, class:"fa-flip-horizontal") %> Vehicle Two<b class="caret"></b>
        <% end %>
        <div class="popover-select hide">
          <%= f.input :vehicle_two_brand, collection: @brands, class:"form-control", label: false, prompt: "Make...", input_html: {class: "chosen-select" } %>
          <%= f.input :vehicle_two_model, collection: [], class: "form-control", label: false, prompt: "Model...", input_html: {class: "chosen-select" } %>
          <%= f.input :vehicle_two_submodel, collection: [], class:"form-control", label: false, prompt: "Submodel..." %>
          <%= f.input :vehicle_two_year, collection: [], prompt: "Year...", label: false, class:"form-control" %>
          <%= hidden_field_tag "compatibility_check[vehicles][][id]", nil, id: "compatibility_check_vehicle_two_id" %>
        </div>
      </div>
    </div>
    <div class="row search-action">
      <div class="col-md-12 action text-center">
        <%= f.submit "Check", id: "compatibility-check-process", class: "btn btn-default" %>
      </div>
    </div>
  </div>
<% end %>

<script type="text/javascript">
  var categories = new Bloodhound({
    datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    prefetch: {url: '/categories/1/leaves.json',
               ttl: 3600000 } // Locally cache results for 1 hr
  });

  $('.typeahead').typeahead({
    hint: true,
    highlight: true,
    autoselect: true
  },
  {
    name: 'categories',
    display: 'name',
    limit: 10,
    source: categories
  });
  $('.typeahead').bind('typeahead:select', function(ev, suggestion) {
    $('#compatibility_check_category_id').val(suggestion.id);
    $('#compatibility_check_category_id').trigger('change');
  });

  $('#compatibility_check_category_id').on("change", function() {
    var select = $('#compatibility_check_fitment_note_id')
    select.empty();
    var categoryId = $(this).val();
    if (categoryId > 0 ) {
      var url = "/categories/"+categoryId+"/fitment_notes";
      $.getJSON(url, function(json){
        if ( json.length > 0 ) {
          select.empty();
          select.append($('<option>').text("Specify..."));
          $.each(json, function(i, obj){
            select.append($('<option>').text(obj.name).attr('value', obj.id));
          });
          select.prop('disabled', false);
        } else {
          select.prop('disabled', true);
        };
      });
    };
  });

  dynamic_vehicle_form("compatibility_check_vehicle_one");
  dynamic_vehicle_form("compatibility_check_vehicle_two");
  update_vehicle_tag("vehicle_one");
  update_vehicle_tag("vehicle_two");
  update_part_tag("category_name", "category_name");
  update_part_tag("fitment_note_id", "part_note");
  $("#compatibility_check_vehicle_one_year").on("change", function() {
    var vehicleId = $(this).val();
    $("#compatibility_check_vehicle_one_id").val(vehicleId);
  });
  $("#compatibility_check_vehicle_two_year").on("change", function() {
    var vehicleId = $(this).val();
    $("#compatibility_check_vehicle_two_id").val(vehicleId);
  });
  function update_vehicle_span(vehicle, attribute) {
    $("#compatibility_check_" + vehicle + "_" + attribute).on("change", function() {
      var optionText = $(this).find("option:selected").text();
      if (optionText !== "-- Base") {
        $("#" + vehicle + "_" + attribute).html(optionText + " ");
      };
    });
  };
  function update_vehicle_tag(vehicle) {
    update_vehicle_span(vehicle, "brand");
    update_vehicle_span(vehicle, "model");
    update_vehicle_span(vehicle, "submodel");
    update_vehicle_span(vehicle, "year");
  };
  function update_part_tag(select, span) {
    $("#compatibility_check_" + select).on('typeahead:selected', function() {
      var text = $(this).val();
      // var optionText = $(this).find("option:selected").text();
      $("#" + span).html(text + " ");
    });
  };
  function show_popover_select(popover) {
    target = $(popover).next('.popover-select');
    if ( $( target ).hasClass( "hide" ) ) {
      target.removeClass('hide');
    } else {
      target.addClass('hide');
    };
  };
</script>
